<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd">
    <head>
        <link href="../Resources/TableStyles/Standard.css" rel="stylesheet" MadCap:stylesheetType="table" />
    </head>
    <body>
        <map id="map2">
            <area shape="rectangle" coords="30,76,460,304" dragDirection="0" href="#Discover" />
            <area shape="rectangle" coords="1232,74,1664,306" dragDirection="0" href="#Connect" />
        </map>
        <MadCap:conditionalText MadCap:conditions="cc_product_conds.not-SCA">
            <map id="map1">
                <area shape="rectangle" coords="69,593,379,753" dragDirection="0" href="#Discover" alt="Read about onboarding an Azure directory" />
                <area shape="rectangle" coords="705,597,1018,747" dragDirection="0" href="#Connect" alt="Read about onboarding a subscription" />
            </map>
        </MadCap:conditionalText>
        <h1>Add Azure - <MadCap:variable name="cv-shared-variables.entra-id-long" /></h1>
        <p>This topic describes how to onboard your Azure directory - <MadCap:variable name="cv-shared-variables.entra-id-long" /> (<MadCap:variable name="cv-shared-variables.entra-id-short" />). You can onboard an entire <MadCap:variable name="cv-shared-variables.entra-id-short" />&#160;directory or you can onboard management groups or subscriptions.</p>
        <h2>Before you begin</h2>
        <ul>
            <li>
                <p>You must have a <MadCap:variable name="cv-shared-variables.entra-id-long" /> directory (tenant) with at least one subscription</p>
            </li>
            <li>
                <p>You must be the global administrator of your <MadCap:variable name="cv-shared-variables.entra-id-long" /> directory</p>
            </li>
            <li>
                <p>If you are onboarding one subscription only, you must be the owner of the root management group in the directory</p>
            </li>
            <li>
                <p>Log in to <MadCap:variable name="cv-shared-variables.entra-id-long" />, go to <span class="Emphasis">Manage &gt; Properties</span>, and make sure that <span class="Emphasis">Can manage access to all Azure subscriptions and management groups in this tenant</span> is selected. Save your changes.</p>
            </li>
        </ul>
        <div class="note">
            <p>We assume you are familiar with navigating the Microsoft Azure Portal and your resources.</p>
        </div>
        <h2>Onboard Microsoft Azure</h2>
        <p>Click the relevant option to learn more about how to onboard a new <MadCap:variable name="cv-shared-variables.entra-id-short" />&#160;directory to CyberArk or how to add a subscription to an already onboarded directory.</p>
        <p>
            <img src="Images/onboard-azure.png" usemap="#map2" />
        </p>
        <h2><a name="Discover"></a>Onboard a new directory</h2>
        <p>This section describes how to onboard an entire Entra ID directory to CyberArk, or just subsections (management groups or subscriptions) of a directory that hasn't yet been onboarded.</p>
        <p>You will need:</p>
        <ul>
            <li>
                <p>Your directory's tenant ID</p>
            </li>
            <li>
                <p>Azure Cloud Shell in Bash mode</p>
            </li>
        </ul>
        <div class="ProcedureHeading">
            <p>To onboard the new directory (or parts thereof):</p>
        </div>
        <ol>
            <li>
                <p> In the <span class="Emphasis">same browser</span>, in separate tabs:</p>
                <ol>
                    <li>
                        <p>Log in to your CyberArk tenant.</p>
                    </li>
                    <li>
                        <p>Log in to your Microsoft Azure Console - keep this open and stay logged in throughout the onboarding process.</p>
                    </li>
                </ol>
            </li>
            <li>
                <p>In your CyberArk tenant, use the service <MadCap:variable name="cc_product_vars.Navigator" /> to go to <MadCap:variable name="cc_product_vars.CV-full" />.</p>
            </li>
            <li>
                <p>In <MadCap:variable name="cc_product_vars.CV-full" />, go to <span class="Emphasis">Settings &gt; Platform management</span> and click <span class="Emphasis">Azure</span>.</p>
            </li>
            <li>
                <p>In the top right corner of the Azure workspace page, click <span class="Emphasis">Add workspace</span>.</p>
            </li>
            <li>
                <p>Select <span class="Emphasis">Onboard new directory</span>, and click <span class="Emphasis">Add</span>.</p>
            </li>
            <li>
                <p>Enter the following directory details:</p>
                <table style="width: 100%;mc-table-style: url('../Resources/TableStyles/Standard.css');" class="TableStyle-Standard" cellspacing="0">
                    <col class="TableStyle-Standard-Column-Column1" />
                    <col class="TableStyle-Standard-Column-Column1" />
                    <thead>
                        <tr class="TableStyle-Standard-Head-Header1">
                            <th class="TableStyle-Standard-HeadE-Column1-Header1">
                                <p>Item</p>
                            </th>
                            <th class="TableStyle-Standard-HeadD-Column1-Header1">
                                <p>Description</p>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="TableStyle-Standard-Body-Body1">
                            <td class="TableStyle-Standard-BodyE-Column1-Body1">
                                <p><span class="Emphasis">Directory (tenant) ID</span>
                                </p>
                            </td>
                            <td class="TableStyle-Standard-BodyD-Column1-Body1">
                                <p>ID assigned to the directory.</p>
                            </td>
                        </tr>
                        <tr class="TableStyle-Standard-Body-Body1">
                            <td class="TableStyle-Standard-BodyB-Column1-Body1">
                                <p><span class="Emphasis">Directory name</span> (optional)</p>
                            </td>
                            <td class="TableStyle-Standard-BodyA-Column1-Body1">
                                <p>Optional name that describes the directory.</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </li>
            <li>
                <p>Select the scope that you want to onboard:</p>
                <table style="width: 100%;mc-table-style: url('../Resources/TableStyles/Standard.css');" class="TableStyle-Standard" cellspacing="0">
                    <col style="width: 50%;" class="TableStyle-Standard-Column-Column1" />
                    <col style="width: 50%;" class="TableStyle-Standard-Column-Column1" />
                    <thead>
                        <tr class="TableStyle-Standard-Head-Header1">
                            <th class="TableStyle-Standard-HeadE-Column1-Header1">
                                <p>Option</p>
                            </th>
                            <th class="TableStyle-Standard-HeadD-Column1-Header1">
                                <p>Details</p>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="TableStyle-Standard-Body-Body1">
                            <td class="TableStyle-Standard-BodyE-Column1-Body1">
                                <p><span class="Emphasis">Onboard the entire directory</span>
                                </p>
                            </td>
                            <td class="TableStyle-Standard-BodyD-Column1-Body1">
                                <p>Onboard the entire directory, including all of its child management groups and subscriptions.</p>
                            </td>
                        </tr>
                        <tr class="TableStyle-Standard-Body-Body1">
                            <td class="TableStyle-Standard-BodyE-Column1-Body1">
                                <p><span class="Emphasis">Onboard specific management groups</span>
                                </p>
                            </td>
                            <td class="TableStyle-Standard-BodyD-Column1-Body1">
                                <p>Enter the IDs of the groups you want to onboard, pressing <span class="Emphasis">Enter </span>after each ID.</p>
                            </td>
                        </tr>
                        <tr class="TableStyle-Standard-Body-Body1">
                            <td class="TableStyle-Standard-BodyB-Column1-Body1">
                                <p><span class="Emphasis">Onboard specific subscriptions</span>
                                </p>
                            </td>
                            <td class="TableStyle-Standard-BodyA-Column1-Body1">
                                <p>Enter the subscription IDs of the subscriptions you want to onboard, pressing <span class="Emphasis">Enter </span>after each ID. </p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </li>
            <MadCap:snippetBlock src="CloudAdminSnippets/ConfigureAzureOnboarding.flsnp" />
            <li MadCap:conditions="cc_product_conds.CEM">
                <p><a name="Connect3"></a>Connect the required Microsoft Azure subscriptions</p>
                <p>Do the following in <MadCap:variable name="cc_product_vars.CV-full" /> to connect the subscriptions you want scanned:</p>
                <ol>
                    <li>
                        <p>Go to the <span class="Emphasis">Setup &gt; Platform management &gt; Azure</span> page.</p>
                    </li>
                    <li>
                        <p>Select the subscriptions to connect. </p>
                    </li>
                </ol>
                <p>For details, see <MadCap:xref href="cv-connect-workspaces.htm#View">View and manage workspace connections</MadCap:xref>.</p>
            </li>
        </ol>
        <h2><a name="Connect"></a>Add a new workspace to an existing directory</h2>
        <p>You can add new or existing management groups and subscriptions to a discovered directory at any time after onboarding the parent directory.</p>
        <ol>
            <li>
                <p>In <MadCap:variable name="cc_product_vars.CV-full" />, go to <span class="Emphasis">Settings &gt; Platform management</span> and click <span class="Emphasis">Azure</span>.</p>
            </li>
            <li>
                <p>In the top right corner of the Azure workspace page, click <span class="Emphasis">Add workspace</span>.</p>
            </li>
            <li>
                <p>Select <span class="Emphasis">Onboard additional subscriptions</span>, and click <span class="Emphasis">Add</span>.</p>
            </li>
            <li>
                <p>Select the scope and provide the requested details:</p>
                <table style="width: 100%;mc-table-style: url('../Resources/TableStyles/Standard.css');" class="TableStyle-Standard" cellspacing="0">
                    <col style="width: 50%;" class="TableStyle-Standard-Column-Column1" />
                    <col style="width: 50%;" class="TableStyle-Standard-Column-Column1" />
                    <thead>
                        <tr class="TableStyle-Standard-Head-Header1">
                            <th class="TableStyle-Standard-HeadE-Column1-Header1">
                                <p>Option</p>
                            </th>
                            <th class="TableStyle-Standard-HeadD-Column1-Header1">
                                <p>Details</p>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="TableStyle-Standard-Body-Body1">
                            <td class="TableStyle-Standard-BodyE-Column1-Body1">
                                <p><span class="Emphasis">Onboard the entire directory</span>
                                </p>
                            </td>
                            <td class="TableStyle-Standard-BodyD-Column1-Body1">
                                <p>Onboard all the resources in the directory that are not yet onboarded, including all of its child management groups and subscriptions.</p>
                            </td>
                        </tr>
                        <tr class="TableStyle-Standard-Body-Body1">
                            <td class="TableStyle-Standard-BodyB-Column1-Body1">
                                <p><span class="Emphasis">Onboard specific subscriptions</span>
                                </p>
                            </td>
                            <td class="TableStyle-Standard-BodyA-Column1-Body1">
                                <p>Enter the subscription IDs of the subscriptions you want to onboard, pressing <span class="Emphasis">Enter </span>after each ID. </p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </li>
            <MadCap:snippetBlock src="CloudAdminSnippets/ConfigureAzureOnboarding.flsnp" MadCap:conditionTagExpression="exclude[snip-conditions.OnboardNewDirectory]" />
        </ol>
        <h2>Reduce permissions in onboarded Azure workspaces</h2>
        <p>If you have Azure workspaces that were onboarded for <MadCap:variable name="cc_product_vars.SCA-short" /> prior to March 13, 2024 you may want to reduce exposure by removing unnecessary permissions from the Azure app that was created during the onboarding process. To do this, onboard the workspaces again. When you copy the onboarding script from <MadCap:variable name="cc_product_vars.CV-full" /> to your Azure console, add the flags described below.</p>
        <div class="ProcedureHeading">To remove excessive permissions</div>
        <ol>
            <li>
                <p>Follow the instructions provided earlier in this topic to onboard a directory or selected scope levels.</p>
            </li>
            <li>
                <p>In the step where you configure Azure to give <MadCap:variable name="cc_C_CyberArk.CompanyName" /> access to your resources, add the following general flag to the script after you copy it from <MadCap:variable name="cc_product_vars.CV-full" /> to your Bash command line:</p>
                <div class="code"><pre><code>--idempotent-mode</code></pre>
                </div>
            </li>
            <li>
                <MadCap:snippetBlock src="CloudAdminSnippets/LeastPrivilegeCommand.flsnp" />
            </li>
        </ol>
        <div class="note">
            <p>Admin consent is granted to the following Graph API permissions of the <MadCap:variable name="cc_product_vars.CV-full" /> and and <MadCap:variable name="cc_product_vars.SCA-short" /> app registrations that are created for <MadCap:variable name="cc_product_vars.SCA-short" />:</p>
            <ul>
                <li><span class="Emphasis"><span class="Emphasis">Group.Create</span></span>
                </li>
                <li><span class="Emphasis">Group.ReadWrite.All </span>
                </li>
                <li><span class="Emphasis"><span class="Emphasis">GroupMember.ReadWrite.All </span></span>
                </li>
                <li><span class="Emphasis">User.Read.All</span>
                </li>
            </ul>
            <p>For more information about permissions, see <a href="/sca/latest/en/content/dpaforcloud/sca_azure_permissions.htm" alt="Link to SCA page that describes the used Azure permissions">Azure permissions</a>.</p>
        </div>
        <div class="SeeAlso" MadCap:conditions="cc_product_conds.CEM">
            <ul>
                <li>
                    <p>
                        <MadCap:xref href="cv-connect-workspaces.htm">Connect and manage workspaces</MadCap:xref>
                    </p>
                </li>
                <li>
                    <p>
                        <MadCap:xref href="../HomeTilesLPs/LP-Tile3.htm">[%=cc_product_vars.CV-full%] scanning process</MadCap:xref>
                    </p>
                </li>
            </ul>
        </div>
        <div class="NextStep" MadCap:conditions="cc_product_conds.SCA">
            <p><a href="/sca/latest/en/content/dpaforcloud/sca_create-azure-web-app.htm" alt="Create a web app for the Azure console" title="Create a web app for the Azure console">Create a web app for the Azure console</a>
            </p>
        </div>
    </body>
</html>